Datamatic=function(t){this._userID=t},Datamatic.prototype={chart:function(t,e){return t&&-1==t.indexOf("/")?new Datamatic.Chart(this._userID+"/"+t,e):new Datamatic.Chart(t,e)}},Datamatic.utils={},Datamatic.utils.delayTask=function(t,e){var a=null,n=function(){a=null,t()},i=function(t){null==a&&(a=setTimeout(n,t||e))};return i.delay=function(t){a&&clearTimeout(a),a=setTimeout(n,t||e)},i.schedule=i,i.call=function(){this.cancel(),t()},i.cancel=function(){a&&clearTimeout(a),a=null},i.isPending=function(){return a},i},Datamatic.ajax={},Datamatic.ajax.x=function(){if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;for(var t,e=["MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0","Microsoft.XmlHttp"],a=0;a<e.length;a++)try{t=new ActiveXObject(e[a]);break}catch(n){}return t},Datamatic.ajax.send=function(t,e,a,n,i){var o=Datamatic.ajax.x();o.open(a,t,i),o.onreadystatechange=function(){4==o.readyState&&e(o.responseText)},"POST"==a&&o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send(n)},Datamatic.ajax.get=function(t,e,a,n){var i=[],o=new Datamatic.Promise;for(var s in e)i.push(encodeURIComponent(s)+"="+encodeURIComponent(e[s]));var r="";return i.length&&(r=-1==t.indexOf("?")?"?"+i.join("&"):i.join("&")),Datamatic.ajax.send(t+r,function(t){"function"==typeof a&&a.apply(this,arguments),o.resolve(t)},"GET",null,n),o},Datamatic.ajax.json=function(){var t=new Datamatic.Promise;return Datamatic.ajax.get.apply(Datamatic.ajax,arguments).then(function(e){t.resolve(JSON.parse(e))}),t},Datamatic.ajax.post=function(t,e,a,n){var i=[];for(var o in e)i.push(encodeURIComponent(o)+"="+encodeURIComponent(e[o]));return Datamatic.ajax.send(t,function(t){"function"==typeof a&&a.apply(this,arguments),promise.resolve(t)},"POST",i.join("&"),n),promise},Datamatic.Promise=function(){this._thens=[]},Datamatic.Promise.prototype={then:function(t,e){this._thens.push({resolve:t,reject:e})},resolve:function(t){this._complete("resolve",t)},reject:function(t){this._complete("reject",t)},_complete:function(t,e){this.then="resolve"===t?function(t){t&&t(e)}:function(t,a){a&&a(e)},this.resolve=this.reject=function(){throw new Error("Promise already completed.")};for(var a,n=0;a=this._thens[n++];)a[t]&&a[t](e);delete this._thens}},Datamatic.Chart=function(t,e){this._id=t,this._options=e};var isIE=function(){var t=navigator.userAgent.toLowerCase();return-1!=t.indexOf("msie")?parseInt(t.split("msie")[1]):!1};Datamatic.Chart.prototype={_postSendboxMessage:function(t){isIE()&&isIE()<10&&(t=JSON.stringify(t)),this._iframe.contentWindow.postMessage(t,"*")},render:function(t){var e=new Datamatic.Promise;return this._iframe=document.createElement("IFRAME"),this._iframe.src="http://sandbox.datamatic.io/echarts/2",this._iframe.setAttribute("frameborder","0"),this._iframe.onload=function(){if(!this._id)throw new Error("Chart ID has to be provided.");Datamatic.ajax.get("http://public.datamatic.io/echarts/2/"+this._id+".json",{},function(t){var a=JSON.parse(t);this._renderSandbox(a.template,JSON.parse(decodeURIComponent(escape(window.atob(a.settings)))),JSON.parse(decodeURIComponent(escape(window.atob(a.data)))),decodeURIComponent(escape(window.atob(a.code)))),e.resolve()}.bind(this))}.bind(this),t.appendChild(this._iframe),e},_renderSandbox:function(t,e,a,n){"undefined"!=typeof this._options.width&&(e.width=this._options.width),"undefined"!=typeof this._options.height&&(e.height=this._options.height),this._iframe.setAttribute("width",e.width),this._iframe.setAttribute("height",e.height),this._iframe.setAttribute("scrolling","no"),e.top=0,e.left=0,this._settings=e,this._data=a,this._postSendboxMessage({action:"render",template:t,settings:e}),n&&this._postSendboxMessage({action:"setCode",code:n}),this._postSendboxMessage({action:"update",template:t,settings:e,data:a})},setData:function(t){t=t||[];var e=function(t){var a=t.children?t.children.map(e):[];return{size:t.value,name:t.name,children:a}},a={children:[{name:"start",size:10,children:t.map(e)}]};this._postSendboxMessage({action:"update",data:a}),this._data=a},setProperties:function(t){this._settings=t,this._postSendboxMessage({action:"update",settings:t})}};