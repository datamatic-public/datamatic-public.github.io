define("echarts/chart/funnel",["require","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","../config","../util/ecData","../util/number","zrender/tool/util","zrender/tool/color","zrender/tool/area","../chart"],function(t){function e(t,e,s,o,a){i.call(this,t,e,s,o,a),this.refresh(o)}var i=t("./base"),s=t("zrender/shape/Text"),o=t("zrender/shape/Line"),a=t("zrender/shape/Polygon"),r=t("../config");r.funnel={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,x:80,y:60,x2:80,y2:60,min:0,max:100,minSize:"0%",maxSize:"100%",sort:"descending",gap:0,funnelAlign:"center",itemStyle:{normal:{borderColor:"#fff",borderWidth:1,label:{show:!0,position:"outer"},labelLine:{show:!0,length:10,lineStyle:{width:1,type:"solid"}}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0},labelLine:{show:!0}}}};var n=t("../util/ecData"),h=t("../util/number"),l=t("zrender/tool/util"),d=t("zrender/tool/color"),c=t("zrender/tool/area");return e.prototype={type:r.CHART_TYPE_FUNNEL,_buildShape:function(){var t=this.series,e=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var i,s=0,o=t.length;o>s;s++)if(t[s].type===r.CHART_TYPE_FUNNEL){if(t[s]=this.reformOption(t[s]),this.legendHoverLink=t[s].legendHoverLink||this.legendHoverLink,i=t[s].name||"",this.selectedMap[i]=e?e.isSelected(i):!0,!this.selectedMap[i])continue;this._buildSingleFunnel(s),this.buildMark(s)}this.addShapeList()},_buildSingleFunnel:function(t){var e=this.component.legend,i=this.series[t],s=this._mapData(t),o=this._getLocation(t);this._paramsMap[t]={location:o,data:s};for(var a,r=0,n=[],l=0,d=s.length;d>l;l++)a=s[l].name,this.selectedMap[a]=e?e.isSelected(a):!0,this.selectedMap[a]&&!isNaN(s[l].value)&&(n.push(s[l]),r++);if(0!==r){for(var c,p,u,g,f=this._buildFunnelCase(t),m=i.funnelAlign,y=i.gap,_=r>1?(o.height-(r-1)*y)/r:o.height,v=o.y,x="descending"===i.sort?this._getItemWidth(t,n[0].value):h.parsePercent(i.minSize,o.width),b="descending"===i.sort?1:0,S=o.centerX,T=[],l=0,d=n.length;d>l;l++)if(a=n[l].name,this.selectedMap[a]&&!isNaN(n[l].value)){switch(c=d-2>=l?this._getItemWidth(t,n[l+b].value):"descending"===i.sort?h.parsePercent(i.minSize,o.width):h.parsePercent(i.maxSize,o.width),m){case"left":p=o.x;break;case"right":p=o.x+o.width-x;break;default:p=S-x/2}u=this._buildItem(t,n[l]._index,e?e.getColor(a):this.zr.getColor(n[l]._index),p,v,x,c,_,m),v+=_+y,g=u.style.pointList,T.unshift([g[0][0]-10,g[0][1]]),T.push([g[1][0]+10,g[1][1]]),0===l&&(0===x?(g=T.pop(),"center"==m&&(T[0][0]+=10),"right"==m&&(T[0][0]=g[0]),T[0][1]-="center"==m?10:15,1==d&&(g=u.style.pointList)):(T[T.length-1][1]-=5,T[0][1]-=5)),x=c}f&&(T.unshift([g[3][0]-10,g[3][1]]),T.push([g[2][0]+10,g[2][1]]),0===x?(g=T.pop(),"center"==m&&(T[0][0]+=10),"right"==m&&(T[0][0]=g[0]),T[0][1]+="center"==m?10:15):(T[T.length-1][1]+=5,T[0][1]+=5),f.style.pointList=T)}},_buildFunnelCase:function(t){var e=this.series[t];if(this.deepQuery([e,this.option],"calculable")){var i=this._paramsMap[t].location,s=10,o={hoverable:!1,style:{pointListd:[[i.x-s,i.y-s],[i.x+i.width+s,i.y-s],[i.x+i.width+s,i.y+i.height+s],[i.x-s,i.y+i.height+s]],brushType:"stroke",lineWidth:1,strokeColor:e.calculableHolderColor||this.ecTheme.calculableHolderColor||r.calculableHolderColor}};return n.pack(o,e,t,void 0,-1),this.setCalculable(o),o=new a(o),this.shapeList.push(o),o}},_getLocation:function(t){var e=this.series[t],i=this.zr.getWidth(),s=this.zr.getHeight(),o=this.parsePercent(e.x,i),a=this.parsePercent(e.y,s),r=null==e.width?i-o-this.parsePercent(e.x2,i):this.parsePercent(e.width,i);return{x:o,y:a,width:r,height:null==e.height?s-a-this.parsePercent(e.y2,s):this.parsePercent(e.height,s),centerX:o+r/2}},_mapData:function(t){function e(t,e){return"-"===t.value?1:"-"===e.value?-1:e.value-t.value}function i(t,i){return-e(t,i)}for(var s=this.series[t],o=l.clone(s.data),a=0,r=o.length;r>a;a++)o[a]._index=a;return"none"!=s.sort&&o.sort("descending"===s.sort?e:i),o},_buildItem:function(t,e,i,s,o,a,r,h,l){var d=this.series,c=d[t],p=c.data[e],u=this.getPolygon(t,e,i,s,o,a,r,h,l);n.pack(u,d[t],t,d[t].data[e],e,d[t].data[e].name),this.shapeList.push(u);var g=this.getLabel(t,e,i,s,o,a,r,h,l);n.pack(g,d[t],t,d[t].data[e],e,d[t].data[e].name),this.shapeList.push(g),this._needLabel(c,p,!1)||(g.invisible=!0);var f=this.getLabelLine(t,e,i,s,o,a,r,h,l);this.shapeList.push(f),this._needLabelLine(c,p,!1)||(f.invisible=!0);var m=[],y=[];return this._needLabelLine(c,p,!0)&&(m.push(f.id),y.push(f.id)),this._needLabel(c,p,!0)&&(m.push(g.id),y.push(u.id)),u.hoverConnect=m,g.hoverConnect=y,u},_getItemWidth:function(t,e){var i=this.series[t],s=this._paramsMap[t].location,o=i.min,a=i.max,r=h.parsePercent(i.minSize,s.width),n=h.parsePercent(i.maxSize,s.width);return e*(n-r)/(a-o)},getPolygon:function(t,e,i,s,o,r,n,h,l){var c,p=this.series[t],u=p.data[e],g=[u,p],f=this.deepMerge(g,"itemStyle.normal")||{},m=this.deepMerge(g,"itemStyle.emphasis")||{},y=this.getItemStyleColor(f.color,t,e,u)||i,_=this.getItemStyleColor(m.color,t,e,u)||("string"==typeof y?d.lift(y,-.2):y);switch(l){case"left":c=s;break;case"right":c=s+(r-n);break;default:c=s+(r-n)/2}var v={zlevel:this.getZlevelBase(),z:this.getZBase(),clickable:this.deepQuery(g,"clickable"),style:{pointList:[[s,o],[s+r,o],[c+n,o+h],[c,o+h]],brushType:"both",color:y,lineWidth:f.borderWidth,strokeColor:f.borderColor},highlightStyle:{color:_,lineWidth:m.borderWidth,strokeColor:m.borderColor}};return this.deepQuery([u,p,this.option],"calculable")&&(this.setCalculable(v),v.draggable=!0),new a(v)},getLabel:function(t,e,i,o,a,r,n,h,p){var u,g=this.series[t],f=g.data[e],m=this._paramsMap[t].location,y=l.merge(l.clone(f.itemStyle)||{},g.itemStyle),_="normal",v=y[_].label,x=v.textStyle||{},b=y[_].labelLine.length,S=this.getLabelText(t,e,_),T=this.getFont(x),z=i;v.position=v.position||y.normal.label.position,"inner"===v.position||"inside"===v.position||"center"===v.position?(u=p,z=Math.max(r,n)/2>c.getTextWidth(S,T)?"#fff":d.reverse(i)):u="left"===v.position?"right":"left";var C={zlevel:this.getZlevelBase(),z:this.getZBase()+1,style:{x:this._getLabelPoint(v.position,o,m,r,n,b,p),y:a+h/2,color:x.color||z,text:S,textAlign:x.align||u,textBaseline:x.baseline||"middle",textFont:T}};return _="emphasis",v=y[_].label||v,x=v.textStyle||x,b=y[_].labelLine.length||b,v.position=v.position||y.normal.label.position,S=this.getLabelText(t,e,_),T=this.getFont(x),z=i,"inner"===v.position||"inside"===v.position||"center"===v.position?(u=p,z=Math.max(r,n)/2>c.getTextWidth(S,T)?"#fff":d.reverse(i)):u="left"===v.position?"right":"left",C.highlightStyle={x:this._getLabelPoint(v.position,o,m,r,n,b,p),color:x.color||z,text:S,textAlign:x.align||u,textFont:T,brushType:"fill"},new s(C)},getLabelText:function(t,e,i){var s=this.series,o=s[t],a=o.data[e],r=this.deepQuery([a,o],"itemStyle."+i+".label.formatter");return r?"function"==typeof r?r.call(this.myChart,{seriesIndex:t,seriesName:o.name||"",series:o,dataIndex:e,data:a,name:a.name,value:a.value}):"string"==typeof r?r=r.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}").replace("{a0}",o.name).replace("{b0}",a.name).replace("{c0}",a.value):void 0:a.name},getLabelLine:function(t,e,i,s,a,r,n,h,d){var c=this.series[t],p=c.data[e],u=this._paramsMap[t].location,g=l.merge(l.clone(p.itemStyle)||{},c.itemStyle),f="normal",m=g[f].labelLine,y=g[f].labelLine.length,_=m.lineStyle||{},v=g[f].label;v.position=v.position||g.normal.label.position;var x={zlevel:this.getZlevelBase(),z:this.getZBase()+1,hoverable:!1,style:{xStart:this._getLabelLineStartPoint(s,u,r,n,d),yStart:a+h/2,xEnd:this._getLabelPoint(v.position,s,u,r,n,y,d),yEnd:a+h/2,strokeColor:_.color||i,lineType:_.type,lineWidth:_.width}};return f="emphasis",m=g[f].labelLine||m,y=g[f].labelLine.length||y,_=m.lineStyle||_,v=g[f].label||v,v.position=v.position,x.highlightStyle={xEnd:this._getLabelPoint(v.position,s,u,r,n,y,d),strokeColor:_.color||i,lineType:_.type,lineWidth:_.width},new o(x)},_getLabelPoint:function(t,e,i,s,o,a,r){switch(t="inner"===t||"inside"===t?"center":t){case"center":return"center"==r?e+s/2:"left"==r?e+10:e+s-10;case"left":return"auto"===a?i.x-10:"center"==r?i.centerX-Math.max(s,o)/2-a:"right"==r?e-(o>s?o-s:0)-a:i.x-a;default:return"auto"===a?i.x+i.width+10:"center"==r?i.centerX+Math.max(s,o)/2+a:"right"==r?i.x+i.width+a:e+Math.max(s,o)+a}},_getLabelLineStartPoint:function(t,e,i,s,o){return"center"==o?e.centerX:s>i?t+Math.min(i,s)/2:t+Math.max(i,s)/2},_needLabel:function(t,e,i){return this.deepQuery([e,t],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(t,e,i){return this.deepQuery([e,t],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},refresh:function(t){t&&(this.option=t,this.series=t.series),this.backupShapeList(),this._buildShape()}},l.inherits(e,i),t("../chart").define("funnel",e),e});