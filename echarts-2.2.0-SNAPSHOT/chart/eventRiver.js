define("echarts/chart/eventRiver",["require","./base","../layout/eventRiver","zrender/shape/Polygon","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","../util/date","zrender/tool/util","zrender/tool/color","../chart"],function(t){function e(t,e,s,o,a){i.call(this,t,e,s,o,a);var r=this;r._ondragend=function(){r.isDragend=!0},this.refresh(o)}var i=t("./base"),s=t("../layout/eventRiver"),o=t("zrender/shape/Polygon");t("../component/axis"),t("../component/grid"),t("../component/dataZoom");var a=t("../config");a.eventRiver={zlevel:0,z:2,clickable:!0,legendHoverLink:!0,itemStyle:{normal:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0,position:"inside",formatter:"{b}"}},emphasis:{borderColor:"rgba(0,0,0,0)",borderWidth:1,label:{show:!0}}}};var r=t("../util/ecData"),n=t("../util/date"),h=t("zrender/tool/util"),l=t("zrender/tool/color");return e.prototype={type:a.CHART_TYPE_EVENTRIVER,_buildShape:function(){var t=this.series;this.selectedMap={},this._dataPreprocessing();for(var e=this.component.legend,i=[],o=0;o<t.length;o++)if(t[o].type===this.type){t[o]=this.reformOption(t[o]),this.legendHoverLink=t[o].legendHoverLink||this.legendHoverLink;var a=t[o].name||"";if(this.selectedMap[a]=e?e.isSelected(a):!0,!this.selectedMap[a])continue;this.buildMark(o),i.push(this.series[o])}s(i,this._intervalX,this.component.grid.getArea()),this._drawEventRiver(),this.addShapeList()},_dataPreprocessing:function(){for(var t,e,i=this.series,s=0,o=i.length;o>s;s++)if(i[s].type===this.type){t=this.component.xAxis.getAxis(i[s].xAxisIndex||0);for(var a=0,r=i[s].eventList.length;r>a;a++){e=i[s].eventList[a].evolution;for(var h=0,l=e.length;l>h;h++)e[h].timeScale=t.getCoord(n.getNewDate(e[h].time)-0),e[h].valueScale=Math.pow(e[h].value,.8)}}this._intervalX=Math.round(this.component.grid.getWidth()/40)},_drawEventRiver:function(){for(var t=this.series,e=0;e<t.length;e++){var i=t[e].name||"";if(t[e].type===this.type&&this.selectedMap[i])for(var s=0;s<t[e].eventList.length;s++)this._drawEventBubble(t[e].eventList[s],e,s)}},_drawEventBubble:function(t,e,i){var s=this.series,a=s[e],n=a.name||"",h=a.eventList[i],d=[h,a],c=this.component.legend,p=c?c.getColor(n):this.zr.getColor(e),u=this.deepMerge(d,"itemStyle.normal")||{},g=this.deepMerge(d,"itemStyle.emphasis")||{},f=this.getItemStyleColor(u.color,e,i,h)||p,m=this.getItemStyleColor(g.color,e,i,h)||("string"==typeof f?l.lift(f,-.2):f),y=this._calculateControlPoints(t),_={zlevel:this.getZlevelBase(),z:this.getZBase(),clickable:this.deepQuery(d,"clickable"),style:{pointList:y,smooth:"spline",brushType:"both",lineJoin:"round",color:f,lineWidth:u.borderWidth,strokeColor:u.borderColor},highlightStyle:{color:m,lineWidth:g.borderWidth,strokeColor:g.borderColor},draggable:"vertical",ondragend:this._ondragend};_=new o(_),this.addLabel(_,a,h,t.name),r.pack(_,s[e],e,s[e].eventList[i],i,s[e].eventList[i].name),this.shapeList.push(_)},_calculateControlPoints:function(t){var e=this._intervalX,i=t.y,s=t.evolution,o=s.length;if(!(1>o)){for(var a=[],r=[],n=0;o>n;n++)a.push(s[n].timeScale),r.push(s[n].valueScale);var h=[];h.push([a[0],i]);var n=0;for(n=0;o-1>n;n++)h.push([(a[n]+a[n+1])/2,r[n]/-2+i]);for(h.push([(a[n]+(a[n]+e))/2,r[n]/-2+i]),h.push([a[n]+e,i]),h.push([(a[n]+(a[n]+e))/2,r[n]/2+i]),n=o-1;n>0;n--)h.push([(a[n]+a[n-1])/2,r[n-1]/2+i]);return h}},ondragend:function(t,e){this.isDragend&&t.target&&(e.dragOut=!0,e.dragIn=!0,e.needRefresh=!1,this.isDragend=!1)},refresh:function(t){t&&(this.option=t,this.series=t.series),this.backupShapeList(),this._buildShape()}},h.inherits(e,i),t("../chart").define("eventRiver",e),e}),define("echarts/layout/eventRiver",["require"],function(){function t(t,a,r){function n(t,e){var i=t.importance,s=e.importance;return i>s?-1:s>i?1:0}function h(t,e){if(t.indexOf)return t.indexOf(e);for(var i=0,s=t.length;s>i;i++)if(t[i]===e)return i;return-1}for(var l=5,d=a,c=0;c<t.length;c++){for(var p=0;p<t[c].eventList.length;p++){null==t[c].eventList[p].weight&&(t[c].eventList[p].weight=1);for(var u=0,g=0;g<t[c].eventList[p].evolution.length;g++)u+=t[c].eventList[p].evolution[g].valueScale;t[c].eventList[p].importance=u*t[c].eventList[p].weight}t[c].eventList.sort(n)}for(var c=0;c<t.length;c++){null==t[c].weight&&(t[c].weight=1);for(var u=0,p=0;p<t[c].eventList.length;p++)u+=t[c].eventList[p].weight;t[c].importance=u*t[c].weight}t.sort(n);for(var f=Number.MAX_VALUE,m=0,c=0;c<t.length;c++)for(var p=0;p<t[c].eventList.length;p++)for(var g=0;g<t[c].eventList[p].evolution.length;g++){var y=t[c].eventList[p].evolution[g].timeScale;f=Math.min(f,y),m=Math.max(m,y)}for(var _=i(Math.floor(f),Math.ceil(m)),v=0,c=0;c<t.length;c++)for(var p=0;p<t[c].eventList.length;p++){var x=t[c].eventList[p];x.time=[],x.value=[];for(var g=0;g<t[c].eventList[p].evolution.length;g++)x.time.push(t[c].eventList[p].evolution[g].timeScale),x.value.push(t[c].eventList[p].evolution[g].valueScale);var b=h(x.value,Math.max.apply(Math,x.value)),S=s(_,x.time[b],x.time[b+1]),g=0;for(x.y=S+x.value[b]/2+l,g=0;g<x.time.length-1;g++){var T=s(_,x.time[g],x.time[g+1]);x.y-x.value[g]/2-l<T&&(x.y=T+x.value[g]/2+l)}var T=s(_,x.time[g],x.time[g]+d);for(x.y-x.value[g]/2-l<T&&(x.y=T+x.value[g]/2+l),t[c].y=x.y,v=Math.max(v,x.y+x.value[b]/2),g=0;g<x.time.length-1;g++)o(_,x.time[g],x.time[g+1],x.y+x.value[g]/2);o(_,x.time[g],x.time[g]+d,x.y+x.value[g]/2)}e(t,r,v,l)}function e(t,e,i,s){for(var o=e.y,a=(e.height-s)/i,r=0;r<t.length;r++){t[r].y=t[r].y*a+o;for(var n=t[r].eventList,h=0;h<n.length;h++){n[h].y=n[h].y*a+o;for(var l=n[h].evolution,d=0;d<l.length;d++)l[d].valueScale*=1*a}}}function i(t,e){var s={left:t,right:e,leftChild:null,rightChild:null,maxValue:0};if(e>t+1){var o=Math.round((t+e)/2);s.leftChild=i(t,o),s.rightChild=i(o,e)}return s}function s(t,e,i){if(1>i-e)return 0;var o=Math.round((t.left+t.right)/2),a=0;if(e==t.left&&i==t.right)a=t.maxValue;else if(o>=i&&null!=t.leftChild)a=s(t.leftChild,e,i);else if(e>=o&&null!=t.rightChild)a=s(t.rightChild,e,i);else{var r=0,n=0;null!=t.leftChild&&(r=s(t.leftChild,e,o)),null!=t.rightChild&&(n=s(t.rightChild,o,i)),a=r>n?r:n}return a}function o(t,e,i,s){if(null!=t){var a=Math.round((t.left+t.right)/2);t.maxValue=t.maxValue>s?t.maxValue:s,(Math.floor(10*e)!=Math.floor(10*t.left)||Math.floor(10*i)!=Math.floor(10*t.right))&&(a>=i?o(t.leftChild,e,i,s):e>=a?o(t.rightChild,e,i,s):(o(t.leftChild,e,a,s),o(t.rightChild,a,i,s)))}}return t});